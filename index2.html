<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Juego de Lógica de Té con Tau-Prolog</title>
    
    <script type="text/javascript" src="tau-prolog/core.js"></script>
    <script type="text/javascript" src="tau-prolog/lists.js"></script>
    <script type="text/javascript" src="tau-prolog/charsio.js"></script>
    <script type="text/javascript" src="tau-prolog/dom.js"></script>
    <script type="text/javascript" src="tau-prolog/format.js"></script>
    <script type="text/javascript" src="tau-prolog/js.js"></script>
    <!-- Eliminado: <script type="text/javascript" src="tau-prolog/clpfd.js"></script> -->
</head> 
    
<style>

    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Great+Vibes&display=swap');    
    @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');

    body {
        font-family: 'Cormorant Garamond', serif; 
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        background-color: #f8f4e3;
        padding: 30px; /* Reducir padding para más espacio */
        color: #4A4A4A;
        line-height: 1.6; 
        box-sizing: border-box;
    }

    h1 {
        font-family: 'Libre Baskerville', serif; /* Fuente más dramática para el título */
        font-weight: 700;
        font-size: 2.8em;
        color: #8B4513; /* Marrón cálido, como té o madera antigua */
        margin-bottom: 25px;
        margin-left: 30px; /* Ajusta con el padding del body */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.1); /* Sutil sombra para dar profundidad */
        letter-spacing: 1px; /* Un poco de espaciado entre letras */
    }

    #output {
        margin-top: 20px; /* Ajustar margen */
        padding: 15px;
        background-color: #FFFCEF; /* Crema más claro */
        border: 1px solid #D2B48C; /* Borde suave y cálido */
        border-radius: 8px;
        width: 90%; /* Ajustar ancho */
        max-width: 900px; /* Ajustar max-width */
        min-height: 80px;
        box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
        white-space: pre-wrap;
        font-family: 'Cormorant Garamond', serif; /* Misma fuente para el output */
        color: #5C4033; /* Marrón oscuro para el texto de output */
        font-size: 0.95em;
    }

    /* Nuevo contenedor para el layout de juego (cartas + mesa) */
    .game-layout {
        display: flex; /* Habilitar flexbox */
        flex-direction: row; /* Elementos en fila (uno al lado del otro) */
        justify-content: center; /* Centrar horizontalmente */
        align-items: flex-start; /* Alinear arriba */
        gap: 30px; /* Espacio entre las secciones */
        width: 100%;
        max-width: 1500px; /* Aumentar el ancho máximo para acomodar el layout */
        margin-top: 25px;
        margin-left: 0;
        margin-right: auto;
    }

    /* Contenedor para las cartas (Personas y Características) */
    .cards-container {
        display: flex;
        flex-direction: column; /* Apilar personas y características */
        gap: 0px; /* Espacio entre los dos contenedores de cartas */
        width: 40%; /* Ocupa un porcentaje del ancho del game-layout */
        min-width: 300px;
        max-width: 380px;
        margin-right: 80px;
    }

    /* Contenedor general para las cartas y condiciones */
    .contenedor-cartas, .contenedor-condiciones {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        padding: 10px;
        background-color: #ffffff;
        border-radius: 15px;
        box-shadow: 4px 4px 12px rgba(0,0,0,0.15);
        width: 350px; /* Ocupa todo el ancho de su padre (.cards-container) */
        justify-content: center;
        border: 2px solid #D2B48C; /* Borde más visible y cálido */
        position: relative; /* Para posibles decoraciones */
        overflow: hidden; /* Asegura que la decoración no se salga */
        margin-top: 20px;
    }
    
    .contenedor-cartas h2, .contenedor-condiciones h2 {
        font-family: 'Playfair Display', serif; /* Fuente del título para los subtítulos */
        font-weight: 600;
        width: 100%;
        text-align: center;
        color: #7B3F00; /* Marrón oscuro para los subtítulos */
        margin-bottom: 15px;
        text-shadow: 0.5px 0.5px 1px rgba(0,0,0,0.05);
        margin-top: 10px;
    }

    /* Estilos específicos para el contenedor de condiciones */
    .contenedor-condiciones {
        flex-direction: column; /* Las condiciones se listan verticalmente */
        align-items: flex-start; /* Alinear el texto a la izquierda */
        margin-left: -80px;
        width: 380px;
    }

    .contenedor-condiciones ul {
        list-style: none; /* Quitar viñetas predeterminadas */
        padding: 0;
        margin: 0;
        width: 100%;
    }

    .contenedor-condiciones li {
        margin-bottom: 8px;
        padding-left: 25px;
        position: relative;
        font-size: 1.2em;
        line-height: 1.5;
        color: #555;
    }

    .contenedor-condiciones li::before {
        content: "•";
        color: #8B4513; /* Color del bullet */
        font-weight: bold;
        display: inline-block;
        width: 1em;
        font-size: 1.2em; /* Bullet un poco más grande */
        transform: translateY(-2px); /* Ajuste vertical del bullet */
        margin-left: 1%;
    }

    .carta {
        width: 120px;
        height: 80px;
        background-color: #FDFCEE; /* Crema muy claro */
        border: 1px solid #CCA080; /* Borde cálido */
        border-radius: 8px;
        box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.18);
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        font-size: 1.2em;
        cursor: grab;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s;
        position: relative;
    }

    .carta:hover {
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.25);
        transform: translateY(-3px);
    }

    .carta:active {
        cursor: grabbing;
        transform: scale(0.97);
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    }

    .persona-carta {
        background-color: #F8E8E8; /* Rosa pálido */
        border-color: #E6B0AA; /* Rojo rosado más suave */
        color: #9A2C2C; /* Rojo más oscuro */
    }

    .caracteristica-carta {
        background-color: #E8F5E8; /* Verde menta pálido */
        border-color: #A7D7B7; /* Verde más suave */
        color: #388E3C; /* Verde oscuro */
        font-size: 1.2em;
        text-align: center;
        line-height: 1.3;
        padding: 5px;
    }

    .dragging {
        opacity: 0.6;
        border: 2px dashed #B17E4C;
        box-shadow: none;
    }

    #mesa-circular {
        position: relative;
        width: 400px; /* Diámetro de la mesa */
        height: 400px;
        border-radius: 50%;
        background-color: #C8E6C9; /* Verde pálido (base) */
        background-image: linear-gradient(45deg, #DCEAE0 25%, transparent 25%, transparent 75%, #DCEAE0 75%, #DCEAE0), 
                          linear-gradient(45deg, #DCEAE0 25%, transparent 25%, transparent 75%, #DCEAE0 75%, #DCEAE0);
        background-size: 20px 20px; /* Tamaño del patrón */
        background-position: 0 0, 10px 10px; /* Offset para el patrón */
        border: 8px double #8B4513; /* Borde doble más grueso y marrón cálido */
        margin-top: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: inset 0 0 15px rgba(0,0,0,0.15), 0 8px 20px rgba(0,0,0,0.25); /* Sombra más pronunciada */
        flex-shrink: 0;
        transition: transform 0.3s ease-in-out;
        margin-right: 0px;
    }

    #mesa-circular::before {
        content: "Mesa de Té";
        font-family: 'Great Vibes', cursive; /* Fuente script para el nombre de la mesa */
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.2em; /* Más grande y elegante */
        font-weight: normal; /* Para fuentes script */
        color: rgba(139, 69, 19, 0.6); /* Marrón semi-transparente */
        text-shadow: 2px 2px 4px rgba(255,255,255,0.8); /* Sombra más fuerte */
        letter-spacing: 2px;
    }

    .asiento-zona {
        position: absolute;
        width: 120px; /* Ligeramente más grandes */
        height: 150px; /* Ligeramente más grandes */
        border: 2px dashed #B17E4C; /* Borde suave marrón */
        border-radius: 15px; /* Bordes más redondeados */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        background-color: rgba(255, 255, 255, 0.85); /* Fondo más opaco */
        color: #666;
        font-size: 0.9em; /* Ligeramente más grande */
        transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15); /* Sombra más notoria */
        padding: 6px;
    }
    
    .asiento-zona.dragover {
        background-color: #E6F5E6; /* Verde pastel más claro */
        border-color: #8B4513; /* Borde marrón más fuerte al arrastrar */
        box-shadow: 0 0 18px rgba(139, 69, 19, 0.6); /* Sombra de arrastre con color de té */
    }

    .asiento-zona p {
        margin: 0;
        padding: 5px;
        font-weight: bold;
        color: #7B3F00; /* Marrón para el texto del asiento */
    }

    .asiento-zona:nth-child(1) { top: 0px; left: 50%; transform: translate(-50%, -50%); }
    .asiento-zona:nth-child(2) { top: 90px; right: 0px; transform: translate(50%, -50%); }
    .asiento-zona:nth-child(3) { bottom: 90px; right: 0px; transform: translate(50%, 50%); }
    .asiento-zona:nth-child(4) { bottom: 0px; left: 50%; transform: translate(-50%, 50%); }
    .asiento-zona:nth-child(5) { bottom: 90px; left: 0px; transform: translate(-50%, 50%) ; }
    .asiento-zona:nth-child(6) { top: 90px; left: 0px; transform: translate(-50%, -50%) ; }

    .asiento-zona > .carta {
        transform: rotate(0deg) !important;
        margin-bottom: 5px;
    }

    .asiento-persona-slot, .asiento-caracteristica-slot {
        width: 100px; /* Ligeramente más anchos */
        height: 65px; /* Ligeramente más altos */
        border: 1px dashed #A08060; /* Borde más cálido */
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 0.8em; /* Ligeramente más grande */
        color: #888;
        margin: 3px; /* Más margen */
        background-color: rgba(255,255,255,0.7);
        overflow: hidden;
        font-weight: 500;
    }
    .asiento-persona-slot.dragover, .asiento-caracteristica-slot.dragover {
        background-color: #F0FFE0; /* Fondo más claro al arrastrar */
        border-color: #8B4513;
    }

    .botones {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }

    button {
        padding: 12px 25px; /* Más padding */
        font-size: 1.05em; /* Un poco más grande */
        background-color: #A0522D; /* Marrón Sutil, como chocolate o té */
        color: white;
        border: 2px solid #8B4513; /* Borde más oscuro */
        border-radius: 8px; /* Más redondeado */
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        margin-top: 35px; /* Más margen superior */
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        letter-spacing: 0.5px;
        font-weight: bold;
        font-family: 'Playfair Display', serif; 
    }

    button:hover {
        background-color: #8B4513; /* Color de té más oscuro */
        transform: translateY(-2px);
        box-shadow: 3px 3px 8px rgba(0,0,0,0.3);
    }
    button:active {
        transform: translateY(0);
        box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }

    /* Pequeña decoración para los contenedores de cartas (opcional) */
    .contenedor-cartas::before, .contenedor-condiciones::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(to bottom, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }
    .contenedor-cartas::after, .contenedor-condiciones::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(to top, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0) 100%);
        pointer-events: none;
    }

    /* Fondo para la mesa (sutil patrón de cuadros) */
    #mesa-circular {
        /* ... tus estilos existentes ... */
        background-color: #E0F2F1; /* Un color base más fresco para la mesa */
        background-image: 
            linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.2) 75%, rgba(255,255,255,0.2)), 
            linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 75%, rgba(255,255,255,0.2) 75%, rgba(255,255,255,0.2));
        background-size: 25px 25px; /* Tamaño del patrón */
        background-position: 0 0, 12.5px 12.5px; /* Offset para el patrón */
        border: 8px double #A0522D; /* Borde color de té más oscuro */
    }

    /* Estilo para el botón de "Verificar Solución" (Marrón Vintage) */
    .button-brown {
        background-color: #A0522D; /* Marrón Sutil, como chocolate o té */
        border: 2px solid #8B4513; /* Borde más oscuro, color té */
    }

    .button-brown:hover {
        background-color: #8B4513; /* Color de té más oscuro al pasar el ratón */
    }

    /* Estilo para el botón de "Generar Solución" (Verde Oscuro Vintage) */
    .button-dark-green {
        background-color: #556B2F; /* Verde Oliva Oscuro, muy vintage */
        border: 2px solid #3F4F24; /* Borde aún más oscuro */
    }

    .button-dark-green:hover {
        background-color: #3F4F24; /* Verde más oscuro al pasar el ratón */
    }
</style>
<body>
    <h1>Juego de Lógica: Las Seis Mujeres del Té</h1>

    <div class="game-layout">
        <div class="contenedor-condiciones">
            <h2>Pistas del Rompecabezas</h2>
            <ul>
                <li>La mujer que admiraba a Marie se sentó enfrente de la señora Ada.</li>
                <li>La mujer que era profesora se sentó enfrente de la señora Katherine.</li>
                <li>Katherine, se sentó entre la mujer que era viajera y la mujer que admiraba a Marie.</li>
                <li>La mujer que odiaba a las polillas se sentó frente a la señora Jane.</li>
                <li>La mujer que odiaba a las polillas se sentó junto a la mujer que era profesora y a la izquierda de la que admiraba a Marie.</li>
                <li>La mujer que era viajera se sentó al lado de la señora Katherine.</li>
                <li>La mujer viajera se sentó al lado de Ada.</li>
                <li>Ada se sentó enfrente de la mujer que admiraba a Marie.</li>
                <li>La señora Chien se sentó junto a la mujer odia las polillas y enfrente de la dueña de casa.</li>
            </ul>
        </div>
        <div class="cards-container">
            <div class="contenedor-cartas" id="personas-disponibles">
                <h2>Personas</h2>
                <div class="carta persona-carta" id="jane" draggable="true">Jane</div>
                <div class="carta persona-carta" id="ada" draggable="true">Ada</div>
                <div class="carta persona-carta" id="katherine" draggable="true">Katherine</div>
                <div class="carta persona-carta" id="marie" draggable="true">Marie</div>
                <div class="carta persona-carta" id="grace" draggable="true">Grace</div>
                <div class="carta persona-carta" id="chien" draggable="true">Chien</div>
            </div>

            <div class="contenedor-cartas" id="caracteristicas-disponibles">
                <h2>Características</h2>
                <div class="carta caracteristica-carta" id="profesora" draggable="true">Profesora</div>
                <div class="carta caracteristica-carta" id="modesta" draggable="true">Modesta</div>
                <div class="carta caracteristica-carta" id="odia_polillas" draggable="true">Odia Polillas</div>
                <div class="carta caracteristica-carta" id="admira_marie" draggable="true">Admira a Marie</div>
                <div class="carta caracteristica-carta" id="viajera" draggable="true">Viajera</div>
                <div class="carta caracteristica-carta" id="duena_casa" draggable="true">Dueña de Casa</div>
            </div>
        </div>

        <div id="mesa-circular">
            <div class="asiento-zona" id="asiento1">
                <p>Asiento 1</p>
                <div class="asiento-persona-slot" data-slot-type="persona">Coloca Persona</div>
                <div class="asiento-caracteristica-slot" data-slot-type="caracteristica">Coloca Característica</div>
            </div>
            <div class="asiento-zona" id="asiento2">
                <p>Asiento 2</p>
                <div class="asiento-persona-slot" data-slot-type="persona">Coloca Persona</div>
                <div class="asiento-caracteristica-slot" data-slot-type="caracteristica">Coloca Característica</div>
            </div>
            <div class="asiento-zona" id="asiento3">
                <p>Asiento 3</p>
                <div class="asiento-persona-slot" data-slot-type="persona">Coloca Persona</div>
                <div class="asiento-caracteristica-slot" data-slot-type="caracteristica">Coloca Característica</div>
            </div>
            <div class="asiento-zona" id="asiento4">
                <p>Asiento 4</p>
                <div class="asiento-persona-slot" data-slot-type="persona">Coloca Persona</div>
                <div class="asiento-caracteristica-slot" data-slot-type="caracteristica">Coloca Característica</div>
            </div>
            <div class="asiento-zona" id="asiento5">
                <p>Asiento 5</p>
                <div class="asiento-persona-slot" data-slot-type="persona">Coloca Persona</div>
                <div class="asiento-caracteristica-slot" data-slot-type="caracteristica">Coloca Característica</div>
            </div>
            <div class="asiento-zona" id="asiento6">
                <p>Asiento 6</p>
                <div class="asiento-persona-slot" data-slot-type="persona">Coloca Persona</div>
                <div class="asiento-caracteristica-slot" data-slot-type="caracteristica">Coloca Característica</div>
            </div>
        </div>
    </div>

    <div class="botones">
        <button id="checkSolutionButton" class="button-brown">Verificar Solución</button>
        <button id="generateSolutionButton" class="button-dark-green">Generar Solución</button>
    </div>

    <pre id="output">Mensajes del juego / depuración de Prolog:</pre>

    <script>
        const output = document.getElementById("output");
        const session = pl.create(1000); // Crea una sesión de Tau-Prolog

        // Variables globales para el arrastre
        let draggedElement = null; // Elemento HTML que se está arrastrando (la carta)
        let draggedElementType = null; // 'persona' o 'caracteristica'

        // Función para agregar mensajes al output
        function logMessage(msg) {
            output.textContent += msg + "\n";
            output.scrollTop = output.scrollHeight; // Auto-scroll
        }

        // --- LÓGICA PROLOG CORREGIDA ---
        session.consult(`
            % Cargar el módulo lists para usar all_distinct/1
            :- use_module(library(lists)).

            % Declarar predicados como dinámicos
            :- dynamic(en_asiento/2).
            :- dynamic(tiene_caracteristica/2).

            % Predicado auxiliar para verificar que todos los elementos de una lista son distintos
            all_distinct([]).
            all_distinct([H|T]) :-
                \\+ member(H,T),
                all_distinct(T).

            % Relación de "enfrente": diferencia absoluta de 3 posiciones (mesa circular de 6 sillas)
            enfrente(H,N) :-
                D is abs(H-N),
                D = 3.

            % Relación de "al lado": diferencia de 1 posición
            al_lado(H,N) :-
                ( D is abs(H-N), D = 1
                ; (H=1, N=6)  % s1 al lado de s6
                ; (H=6, N=1)  % s6 al lado de s1
                ).

            % Relación de "a la izquierda": H está justo antes que N en sentido horario
            izquierda(H,N) :-
                ( N = 1, H = 6 % Si N es asiento1, H es asiento6
                ; H is N - 1  % Si N es 2, H es 1; Si N es 3, H es 2, etc.
                ).

            % Definición de las personas
            persona(jane). persona(ada). persona(katherine).
            persona(marie). persona(grace). persona(chien).

            % Definición de las características
            caracteristica(profesora). caracteristica(modesta). caracteristica(odia_polillas).
            caracteristica(admira_marie). caracteristica(viajera). caracteristica(duena_casa).

            % Mapeo de IDs de asientos HTML a números
            asiento_id_a_num(asiento1, 1).
            asiento_id_a_num(asiento2, 2).
            asiento_id_a_num(asiento3, 3).
            asiento_id_a_num(asiento4, 4).
            asiento_id_a_num(asiento5, 5).
            asiento_id_a_num(asiento6, 6).

            % Predicado para obtener la persona con una característica dada
            persona_con_caracteristica(Persona, Caracteristica) :-
                tiene_caracteristica(Persona, Caracteristica).

            % Predicado para obtener el asiento de una persona
            asiento_de_persona(Persona, AsientoNum) :-
                en_asiento(Persona, AsientoID),
                asiento_id_a_num(AsientoID, AsientoNum).

            % --- Pistas del problema ---

            % Pista 1: La mujer que admiraba a Marie se sentó enfrente de la señora Ada
            pista_1_ok :-
                persona_con_caracteristica(PersonaAdmiraMarie, admira_marie),
                asiento_de_persona(PersonaAdmiraMarie, AsientoAdmiraMarieNum),
                asiento_de_persona(ada, AsientoAdaNum),
                enfrente(AsientoAdmiraMarieNum, AsientoAdaNum).

            % Pista 2: La mujer que era profesora se sentó enfrente de la señora Katherine
            pista_2_ok :-
                persona_con_caracteristica(PersonaProfesora, profesora),
                asiento_de_persona(PersonaProfesora, AsientoProfesoraNum),
                asiento_de_persona(katherine, AsientoKatherineNum),
                enfrente(AsientoProfesoraNum, AsientoKatherineNum).

            % Pista 3: Katherine se sentó entre la mujer que era viajera y la mujer que admiraba a Marie
            pista_3_ok :-
                asiento_de_persona(katherine, AsientoKatherineNum),
                persona_con_caracteristica(PersonaViajera, viajera),
                persona_con_caracteristica(PersonaAdmiraMarie, admira_marie),
                asiento_de_persona(PersonaViajera, AsientoViajeraNum),
                asiento_de_persona(PersonaAdmiraMarie, AsientoAdmiraMarieNum),
                al_lado(AsientoKatherineNum, AsientoViajeraNum),
                al_lado(AsientoKatherineNum, AsientoAdmiraMarieNum),
                PersonaViajera \\= PersonaAdmiraMarie.

            % Pista 4: La mujer que odiaba a las polillas se sentó frente a la señora Jane
            pista_4_ok :-
                persona_con_caracteristica(PersonaOdiaPolillas, odia_polillas),
                asiento_de_persona(PersonaOdiaPolillas, AsientoOdiaPolillasNum),
                asiento_de_persona(jane, AsientoJaneNum),
                enfrente(AsientoOdiaPolillasNum, AsientoJaneNum).

            % Pista 5: La mujer que odiaba a las polillas se sentó junto a la mujer que era profesora y a la izquierda de la que admiraba a Marie
            pista_5_ok :-
                persona_con_caracteristica(PersonaOdiaPolillas, odia_polillas),
                persona_con_caracteristica(PersonaProfesora, profesora),
                persona_con_caracteristica(PersonaAdmiraMarie, admira_marie),
                asiento_de_persona(PersonaOdiaPolillas, AsientoOdiaPolillasNum),
                asiento_de_persona(PersonaProfesora, AsientoProfesoraNum),
                asiento_de_persona(PersonaAdmiraMarie, AsientoAdmiraMarieNum),
                al_lado(AsientoOdiaPolillasNum, AsientoProfesoraNum),
                izquierda(AsientoOdiaPolillasNum, AsientoAdmiraMarieNum).

            % Pista 6: La mujer que era viajera se sentó al lado de la señora Katherine
            pista_6_ok :-
                persona_con_caracteristica(PersonaViajera, viajera),
                asiento_de_persona(PersonaViajera, AsientoViajeraNum),
                asiento_de_persona(katherine, AsientoKatherineNum),
                al_lado(AsientoViajeraNum, AsientoKatherineNum).

            % Pista 7: La mujer viajera se sentó al lado de Ada
            pista_7_ok :-
                persona_con_caracteristica(PersonaViajera, viajera),
                asiento_de_persona(PersonaViajera, AsientoViajeraNum),
                asiento_de_persona(ada, AsientoAdaNum),
                al_lado(AsientoViajeraNum, AsientoAdaNum).

            % Pista 8: Ada se sentó enfrente de la mujer que admiraba a Marie
            pista_8_ok :-
                asiento_de_persona(ada, AsientoAdaNum),
                persona_con_caracteristica(PersonaAdmiraMarie, admira_marie),
                asiento_de_persona(PersonaAdmiraMarie, AsientoAdmiraMarieNum),
                enfrente(AsientoAdaNum, AsientoAdmiraMarieNum).

            % Pista 9: La señora Chien se sentó junto a la mujer que odia las polillas y enfrente de la dueña de casa
            pista_9_ok :-
                asiento_de_persona(chien, AsientoChienNum),
                persona_con_caracteristica(PersonaOdiaPolillas, odia_polillas),
                persona_con_caracteristica(PersonaDuenaCasa, duena_casa),
                asiento_de_persona(PersonaOdiaPolillas, AsientoOdiaPolillasNum),
                asiento_de_persona(PersonaDuenaCasa, AsientoDuenaCasaNum),
                al_lado(AsientoChienNum, AsientoOdiaPolillasNum),
                enfrente(AsientoChienNum, AsientoDuenaCasaNum).

            % Regla principal para verificar la solución completa
            verificar_solucion_completa :-
                pista_1_ok,
                pista_2_ok,
                pista_3_ok,
                pista_4_ok,
                pista_5_ok,
                pista_6_ok,
                pista_7_ok,
                pista_8_ok,
                pista_9_ok.

            % Verificar que cada persona tiene una característica única
            verificar_unicidad_asignaciones :-
                findall(P-C, tiene_caracteristica(P,C), Asignaciones),
                length(Asignaciones, 6),
                maplist(arg(1), Asignaciones, PersonasAsignadas),
                all_distinct(PersonasAsignadas),
                maplist(arg(2), Asignaciones, CaracteristicasAsignadas),
                all_distinct(CaracteristicasAsignadas).

            % Verificar que cada asiento tiene una persona única
            verificar_unicidad_asientos :-
                findall(P-A, en_asiento(P,A), Ubicaciones),
                length(Ubicaciones, 6),
                maplist(arg(1), Ubicaciones, PersonasUbicadas),
                all_distinct(PersonasUbicadas),
                maplist(arg(2), Ubicaciones, AsientosOcupados),
                all_distinct(AsientosOcupados).

            % Predicado final que combina todas las verificaciones
            solucion_final_completa :-
                verificar_unicidad_asignaciones,
                verificar_unicidad_asientos,
                verificar_solucion_completa.
            % Predicado para generar una solución

                        % Solución conocida para pruebas
            solucion_conocida(AsignacionesAsientos, AsignacionesCaracteristicas) :-
                AsignacionesAsientos = [
                    en_asiento(jane, asiento1),
                    en_asiento(ada, asiento2),
                    en_asiento(katherine, asiento3),
                    en_asiento(chien, asiento4),
                    en_asiento(grace, asiento5),
                    en_asiento(marie, asiento6)
                ],
                AsignacionesCaracteristicas = [
                    tiene_caracteristica(jane, odia_polillas),
                    tiene_caracteristica(ada, viajera),
                    tiene_caracteristica(katherine, modesta),
                    tiene_caracteristica(chien, admira_marie),
                    tiene_caracteristica(grace, profesora),
                    tiene_caracteristica(marie, duena_casa)
                ],
                solucion_final_completa.

            % Generar solución simplificada con depuración
                        generar_solucion(AsignacionesAsientos, AsignacionesCaracteristicas) :-
                (solucion_conocida(AsignacionesAsientos, AsignacionesCaracteristicas) -> true ;
                 (Personas = [jane, ada, katherine, marie, grace, chien],
                  Asientos = [asiento1, asiento2, asiento3, asiento4, asiento5, asiento6],
                  Caracteristicas = [profesora, modesta, odia_polillas, admira_marie, viajera, duena_casa],
                  permutation(Personas, PersonasAsignadas),
                  maplist(en_asiento, PersonasAsignadas, Asientos, AsignacionesAsientos),
                  permutation(Caracteristicas, CaracteristicasAsignadas),
                  maplist(tiene_caracteristica, Personas, CaracteristicasAsignadas, AsignacionesCaracteristicas),
                  solucion_final_completa)).

            en_asiento(Persona, Asiento, en_asiento(Persona, Asiento)).
            tiene_caracteristica(Persona, Caracteristica, tiene_caracteristica(Persona, Caracteristica)).
        `, {
            success: function () {
                logMessage("Prolog: Lógica del juego cargada correctamente.");
            },
            error: function (err) {
                logMessage("Prolog ERROR al cargar la lógica: " + pl.format_answer(err));
                console.error("Prolog Error:", err);
            },
        });

        // --- MANEJADORES DE EVENTOS DE DRAG & DROP ---

        document.querySelectorAll('.carta').forEach(carta => {
            carta.addEventListener('dragstart', (e) => {
                draggedElement = e.target;
                draggedElementType = e.target.classList.contains('persona-carta') ? 'persona' : 'caracteristica';
                e.dataTransfer.setData('text/plain', e.target.id);
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => {
                    e.target.classList.add('dragging');
                }, 0);
                logMessage(`Arrastrando: ${e.target.id} (${draggedElementType})`);
            });

            carta.addEventListener('dragend', (e) => {
                e.target.classList.remove('dragging');
                draggedElement = null;
                draggedElementType = null;
                logMessage(`Terminó el arrastre para: ${e.target.id}`);
            });
        });

        document.querySelectorAll('.asiento-persona-slot, .asiento-caracteristica-slot').forEach(slot => {
            slot.addEventListener('dragover', (e) => {
                e.preventDefault();
                const targetSlotType = slot.dataset.slotType;
                if (draggedElementType === targetSlotType) {
                    e.dataTransfer.dropEffect = 'move';
                    slot.classList.add('dragover');
                } else {
                    e.dataTransfer.dropEffect = 'none';
                }
            });

            slot.addEventListener('dragleave', (e) => {
                slot.classList.remove('dragover');
            });

            slot.addEventListener('drop', (e) => {
                e.preventDefault();
                slot.classList.remove('dragover');

                const idCarta = e.dataTransfer.getData('text/plain');
                const cartaSoltada = document.getElementById(idCarta);
                const targetSlotType = slot.dataset.slotType;

                if (!cartaSoltada || draggedElementType !== targetSlotType) {
                    logMessage("Movimiento inválido: Tipo de carta incorrecto para este slot.");
                    return;
                }

                const oldParentSlot = cartaSoltada.parentElement;
                if (oldParentSlot && (oldParentSlot.classList.contains('asiento-persona-slot') || oldParentSlot.classList.contains('asiento-caracteristica-slot'))) {
                    const parentOfOldSlot = oldParentSlot.parentElement;
                    if (parentOfOldSlot && parentOfOldSlot.classList.contains('asiento-zona')) {
                        oldParentSlot.textContent = `Coloca ${targetSlotType === 'persona' ? 'Persona' : 'Característica'}`;
                    }
                }

                slot.innerHTML = '';
                slot.appendChild(cartaSoltada);
                // Usar el ID del asiento padre como destino
                const slotId = slot.parentElement.id; // Obtener el ID del asiento-zona (asiento1, asiento2, etc.)
                logMessage(`Movida: ${idCarta} a ${slotId} (${targetSlotType})`);
            });
        });

        // --- Botón de Verificar Solución ---
        document.getElementById('checkSolutionButton').addEventListener('click', () => {
            logMessage("Verificando solución con Prolog...");

            // Paso 1: Retractar todos los hechos dinámicos
            const retractPromises = [
                new Promise((resolve, reject) => session.query("retractall(en_asiento(_,_)).", { success: () => session.answer({ success: resolve, error: reject, fail: resolve }), error: reject })),
                new Promise((resolve, reject) => session.query("retractall(tiene_caracteristica(_,_)).", { success: () => session.answer({ success: resolve, error: reject, fail: resolve }), error: reject }))
            ];

            Promise.all(retractPromises).then(() => {
                // Paso 2: Recopilar el estado actual del DOM y asertarlo en Prolog
                const assertPromises = [];
                const asientos = document.querySelectorAll('.asiento-zona');

                asientos.forEach(asiento => {
                    const idAsiento = asiento.id;
                    const personaCarta = asiento.querySelector('.asiento-persona-slot .persona-carta');
                    const caracteristicaCarta = asiento.querySelector('.asiento-caracteristica-slot .caracteristica-carta');

                    if (personaCarta) {
                        const idPersona = personaCarta.id;
                        const query = `asserta(en_asiento(${idPersona}, ${idAsiento})).`;
                        assertPromises.push(new Promise((resolve, reject) => {
                            session.query(query, {
                                success: () => session.answer({ success: resolve, error: reject, fail: resolve }),
                                error: reject
                            });
                        }));
                    }
                    if (caracteristicaCarta && personaCarta) {
                        const idPersona = personaCarta.id;
                        const idCaracteristica = caracteristicaCarta.id;
                        const query = `asserta(tiene_caracteristica(${idPersona}, ${idCaracteristica})).`;
                        assertPromises.push(new Promise((resolve, reject) => {
                            session.query(query, {
                                success: () => session.answer({ success: resolve, error: reject, fail: resolve }),
                                error: reject
                            });
                        }));
                    } else if (caracteristicaCarta && !personaCarta) {
                        logMessage(`Advertencia: Característica ${caracteristicaCarta.id} en ${idAsiento} sin persona asignada.`);
                    }
                });

                // Paso 3: Verificar la solución
                Promise.all(assertPromises).then(() => {
                    session.query("solucion_final_completa.", {
                        success: function(goal) {
                            session.answer({
                                success: function(answer) {
                                    logMessage("¡SOLUCIÓN CORRECTA! Todas las pistas se cumplen.");
                                    console.log("Solución correcta:", pl.format_answer(answer));
                                },
                                fail: function() {
                                    logMessage("SOLUCIÓN INCORRECTA. No todas las pistas se cumplen o el estado es incompleto.");
                                },
                                error: function(err) {
                                    logMessage("Prolog ERROR al verificar la solución: " + pl.format_answer(err));
                                    console.error("Prolog error (solucion_final_completa):", err);
                                }
                            });
                        },
                        error: function(err) {
                            logMessage("Prolog ERROR al parsear 'solucion_final_completa': " + pl.format_answer(err));
                            console.error("Prolog query parse error (solucion_final_completa):", err);
                        }
                    });
                }).catch(error => {
                    logMessage("ERROR al asertar hechos en Prolog: " + error);
                    console.error("Error asserting facts:", error);
                });
            }).catch(error => {
                logMessage("ERROR al retractar hechos en Prolog: " + error);
                console.error("Error retracting facts:", error);
            });
        });
        // --- Botón de Generar Solución ---
        document.getElementById('generateSolutionButton').addEventListener('click', () => {
            logMessage("Generando solución con Prolog...");

            // Paso 1: Retractar todos los hechos dinámicos
            const retractPromises = [
                new Promise((resolve, reject) => session.query("retractall(en_asiento(_,_)).", { success: () => session.answer({ success: resolve, error: reject, fail: resolve }), error: reject })),
                new Promise((resolve, reject) => session.query("retractall(tiene_caracteristica(_,_)).", { success: () => session.answer({ success: resolve, error: reject, fail: resolve }), error: reject }))
            ];

            Promise.all(retractPromises).then(() => {
                // Paso 2: Limpiar el DOM (devolver cartas a contenedores iniciales)
                const personasContenedor = document.getElementById('personas-disponibles');
                const caracteristicasContenedor = document.getElementById('caracteristicas-disponibles');
                document.querySelectorAll('.persona-carta').forEach(carta => {
                    personasContenedor.appendChild(carta);
                });
                document.querySelectorAll('.caracteristica-carta').forEach(carta => {
                    caracteristicasContenedor.appendChild(carta);
                });
                document.querySelectorAll('.asiento-persona-slot').forEach(slot => {
                    slot.innerHTML = 'Coloca Persona';
                });
                document.querySelectorAll('.asiento-caracteristica-slot').forEach(slot => {
                    slot.innerHTML = 'Coloca Característica';
                });

                // Paso 3: Generar la solución
                session.query("generar_solucion(AsignacionesAsientos, AsignacionesCaracteristicas).", {
                    success: function() {
                        session.answer({
                            success: function(answer) {
                                // Procesar la solución
                                const asignacionesAsientos = answer.links.AsignacionesAsientos.value;
                                const asignacionesCaracteristicas = answer.links.AsignacionesCaracteristicas.value;

                                // Convertir las listas de Prolog a estructuras JavaScript
                                const parseList = (list) => {
                                    const result = [];
                                    let current = list;
                                    while (current.id === '.') {
                                        result.push(current.args[0].id);
                                        current = current.args[1];
                                    }
                                    return result;
                                };

                                const parseAsignaciones = (list) => {
                                    const result = [];
                                    let current = list;
                                    while (current.id === '.') {
                                        const fact = current.args[0];
                                        const persona = fact.args[0].id;
                                        const value = fact.args[1].id;
                                        result.push({ persona, value });
                                        current = current.args[1];
                                    }
                                    return result;
                                };

                                const asientos = parseAsignaciones(asignacionesAsientos);
                                const caracteristicas = parseAsignaciones(asignacionesCaracteristicas);

                                // Actualizar el DOM con la solución
                                asientos.forEach(({ persona, value: asiento }) => {
                                    const carta = document.getElementById(persona);
                                    const slot = document.querySelector(`#${asiento} .asiento-persona-slot`);
                                    slot.innerHTML = '';
                                    slot.appendChild(carta);
                                    logMessage(`Asignada: ${persona} a ${asiento} (persona)`);
                                });

                                caracteristicas.forEach(({ persona, value: caracteristica }) => {
                                    const carta = document.getElementById(caracteristica);
                                    const asiento = asientos.find(a => a.persona === persona).value;
                                    const slot = document.querySelector(`#${asiento} .asiento-caracteristica-slot`);
                                    slot.innerHTML = '';
                                    slot.appendChild(carta);
                                    logMessage(`Asignada: ${caracteristica} a ${persona} en ${asiento} (característica)`);
                                });

                                logMessage("¡Solución generada correctamente!");
                            },
                            fail: function() {
                                logMessage("No se encontró una solución válida.");
                            },
                            error: function(err) {
                                logMessage("Prolog ERROR al generar la solución: " + pl.format_answer(err));
                                console.error("Prolog error (generar_solucion):", err);
                            }
                        });
                    },
                    error: function(err) {
                        logMessage("Prolog ERROR al parsear 'generar_solucion': " + pl.format_answer(err));
                        console.error("Prolog query parse error (generar_solucion):", err);
                    }
                });
            }).catch(error => {
                logMessage("ERROR al retractar hechos en Prolog: " + error);
                console.error("Error retracting facts:", error);
            });
        });
        // Mensaje inicial
        logMessage("Arrastra las personas a los asientos y las características a los slots correspondientes.");
        logMessage("Luego, haz clic en 'Verificar Solución'.");
    </script>
</body>
</html>